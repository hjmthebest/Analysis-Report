%pyspark

base = spark.sql("""
    with first_purchase as (
        select a.dpstr_cust_no
             , min(a.std_dt) as fst_pch
        from lpciddm.tb_dmcs_dditmnocustitgslngdtl_f a
        join lpciddm.tb_dmcs_mmcustinfo_f b
            on a.dpstr_cust_no = b.dpstr_cust_no
            and a.std_ym = b.std_ym
        where 1 = 1
            and a.std_ym between '202101' and '202112'  
            and a.typbu_dtl_cd = '01'
            and a.on_off_cl_cd = '1'
            and a.cstr_cd in ('0001', '0002', '0005')
        group by 1
        having sum(a.gs_slng_amt) > 0
    ), base_v2 as (
        select a.dpstr_cust_no
             , c.fst_pch
             , date_format(c.fst_pch, 'yyyyMM') as cohort_group
             , floor(datediff(a.std_dt, c.fst_pch) / 30) as cohort_index
        from lpciddm.tb_dmcs_dditmnocustitgslngdtl_f a
        join lpciddm.tb_dmcs_mmcustinfo_f b
            on a.dpstr_cust_no = b.dpstr_cust_no
            and a.std_ym = b.std_ym
        left join first_purchase c
            on a.dpstr_cust_no = c.dpstr_cust_no
        where 1 = 1
            and a.std_ym between '202101' and '202112'  
            and a.typbu_dtl_cd = '01'
            and a.on_off_cl_cd = '1'
            and a.cstr_cd in ('0001', '0002', '0005')
        group by 1, 2, 3, 4
        having sum(a.gs_slng_amt) > 0    
    )
    select t.cohort_group
         , t.cohort_index
         , count(distinct t.dpstr_cust_no) as cnt
    from base_v2 t
    group by 1, 2
    order by 1, 2

    """)

base.createOrReplaceTempView("base")
base.cache()
base.show()

# Result
+------------+------------+------+
|cohort_group|cohort_index|   cnt|
+------------+------------+------+
|      202101|           0|360018|
|      202101|           1|149963|
|      202101|           2|144846|
|      202101|           3|143596|
|      202101|           4|136483|
|      202101|           5|134185|
|      202101|           6|120489|
|      202101|           7|123654|
|      202101|           8|126814|
|      202101|           9|128434|
|      202101|          10|130679|
|      202101|          11|108724|
|      202101|          12| 10215|
|      202102|           0|237165|
|      202102|           1| 55467|
|      202102|           2| 54582|
|      202102|           3| 52545|
|      202102|           4| 50614|
|      202102|           5| 42223|
|      202102|           6| 43036|
|      202102|           7| 51421|
|      202102|           8| 49222|
|      202102|           9| 49510|
|      202102|          10| 39215|
|      202102|          11|  1133|
|      202103|           0|197603|
|      202103|           1| 37315|
|      202103|           2| 35468|
|      202103|           3| 35678|
|      202103|           4| 27619|
|      202103|           5| 28500|
|      202103|           6| 31620|
|      202103|           7| 34079|
|      202103|           8| 33105|
|      202103|           9| 25876|
|      202103|          10|  1337|
|      202104|           0|158953|
|      202104|           1| 24146|
|      202104|           2| 23343|
|      202104|           3| 19247|
|      202104|           4| 19077|
|      202104|           5| 21100|
|      202104|           6| 22396|
|      202104|           7| 22948|
|      202104|           8| 17272|
|      202104|           9|   731|
|      202105|           0|149503|
|      202105|           1| 19221|
|      202105|           2| 15445|
|      202105|           3| 15886|
|      202105|           4| 17318|
|      202105|           5| 17931|
|      202105|           6| 17976|
|      202105|           7| 13906|
|      202105|           8|   573|
|      202106|           0|132050|
|      202106|           1| 13140|
|      202106|           2| 12658|
|      202106|           3| 14076|
|      202106|           4| 14712|
|      202106|           5| 14303|
|      202106|           6| 10543|
|      202106|           7|   232|
|      202107|           0|101169|
|      202107|           1| 10227|
|      202107|           2| 10209|
|      202107|           3| 10584|
|      202107|           4| 10687|
|      202107|           5|  7925|
|      202107|           6|   311|
|      202108|           0| 93054|
|      202108|           1|  9452|
|      202108|           2|  9132|
|      202108|           3|  9177|
|      202108|           4|  6307|
|      202108|           5|   117|
|      202109|           0| 93900|
|      202109|           1|  9801|
|      202109|           2|  9301|
|      202109|           3|  6511|
|      202109|           4|    42|
|      202110|           0|110123|
|      202110|           1| 10523|
|      202110|           2|  6742|
|      202110|           3|    78|
|      202111|           0|102573|
|      202111|           1|  6196|
|      202111|           2|    17|
|      202112|           0|113809|
|      202112|           1|    15|
+------------+------------+------+

coho = base.toPandas()
coho

# Result
   cohort_group  cohort_index     cnt
0        202101             0  360018
1        202101             1  149963
2        202101             2  144846
3        202101             3  143596
4        202101             4  136483
5        202101             5  134185
6        202101             6  120489
7        202101             7  123654
8        202101             8  126814
9        202101             9  128434
10       202101            10  130679
11       202101            11  108724
12       202101            12   10215
13       202102             0  237165
14       202102             1   55467
15       202102             2   54582
16       202102             3   52545
17       202102             4   50614
18       202102             5   42223
19       202102             6   43036
20       202102             7   51421
21       202102             8   49222
22       202102             9   49510
23       202102            10   39215
24       202102            11    1133
25       202103             0  197603
26       202103             1   37315
27       202103             2   35468
28       202103             3   35678
29       202103             4   27619
30       202103             5   28500
31       202103             6   31620
32       202103             7   34079
33       202103             8   33105
34       202103             9   25876
35       202103            10    1337
36       202104             0  158953
37       202104             1   24146
38       202104             2   23343
39       202104             3   19247
40       202104             4   19077
41       202104             5   21100
42       202104             6   22396
43       202104             7   22948
44       202104             8   17272
45       202104             9     731
46       202105             0  149503
47       202105             1   19221
48       202105             2   15445
49       202105             3   15886
50       202105             4   17318
51       202105             5   17931
52       202105             6   17976
53       202105             7   13906
54       202105             8     573
55       202106             0  132050
56       202106             1   13140
57       202106             2   12658
58       202106             3   14076
59       202106             4   14712
60       202106             5   14303
61       202106             6   10543
62       202106             7     232
63       202107             0  101169
64       202107             1   10227
65       202107             2   10209
66       202107             3   10584
67       202107             4   10687
68       202107             5    7925
69       202107             6     311
70       202108             0   93054
71       202108             1    9452
72       202108             2    9132
73       202108             3    9177
74       202108             4    6307
75       202108             5     117
76       202109             0   93900
77       202109             1    9801
78       202109             2    9301
79       202109             3    6511
80       202109             4      42
81       202110             0  110123
82       202110             1   10523
83       202110             2    6742
84       202110             3      78
85       202111             0  102573
86       202111             1    6196
87       202111             2      17
88       202112             0  113809
89       202112             1      15

coho2 = coho.groupby(['cohort_group', 'cohort_index'])['cnt'].agg('sum').reset_index().pivot(index='cohort_group', columns='cohort_index', values='cnt').fillna(0)
coho_final = coho2.div(coho2[0], axis=0)
coho_final

# Result
cohort_index   0         1         2         3         4         5         6         7         8         9         10        11        12
cohort_group                                                                                                                             
202101        1.0  0.416543  0.402330  0.398858  0.379100  0.372717  0.334675  0.343466  0.352243  0.356743  0.362979  0.301996  0.028374
202102        1.0  0.233875  0.230144  0.221555  0.213413  0.178032  0.181460  0.216815  0.207543  0.208758  0.165349  0.004777  0.000000
202103        1.0  0.188838  0.179491  0.180554  0.139770  0.144229  0.160018  0.172462  0.167533  0.130949  0.006766  0.000000  0.000000
202104        1.0  0.151907  0.146855  0.121086  0.120017  0.132744  0.140897  0.144370  0.108661  0.004599  0.000000  0.000000  0.000000
202105        1.0  0.128566  0.103309  0.106259  0.115837  0.119937  0.120238  0.093015  0.003833  0.000000  0.000000  0.000000  0.000000
202106        1.0  0.099508  0.095858  0.106596  0.111412  0.108315  0.079841  0.001757  0.000000  0.000000  0.000000  0.000000  0.000000
202107        1.0  0.101088  0.100910  0.104617  0.105635  0.078334  0.003074  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
202108        1.0  0.101575  0.098137  0.098620  0.067778  0.001257  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
202109        1.0  0.104377  0.099052  0.069340  0.000447  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
202110        1.0  0.095557  0.061222  0.000708  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
202111        1.0  0.060406  0.000166  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
202112        1.0  0.000132  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000

import seaborn as sns
import matplotlib.pyplot as plt

plt.figure(figsize=(10, 8))
sns.heatmap(coho_final, annot=True, fmt='.0%', cmap='YlGnBu')
plt.xlabel('Cohort_index', fontsize=15)
plt.ylabel('Cohort_group', fontsize=15)
plt.title('Cohort: Customer Retention', fontsize=18)
plt.tight_layout()
